name: Kube-News
on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - feature/*
    workflow_dispatch:
        inputs:
            ambiente:
                description: 'Ambiente de destino'
                required: false
                default: 'dev'
            dockerfile_path:
                description: 'Caminho do Dockerfile'
                required: false
                default: './src/Dockerfile'
jobs:
    build:
        environment: ${{ github.event.inputs.ambiente || 'dev' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2


            - name: Authenticate with Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_PASSWORD }}

            - name: Build Docker image
              run: |
                  docker build -f ${{ github.event.inputs.dockerfile_path || './src/Dockerfile' }} -t ${{ secrets.DOCKER_HUB_USERNAME }}/kube-news:${{ github.sha }} ./src

            - name: Push Docker image
              run: |
                  docker push ${{ secrets.DOCKER_HUB_USERNAME }}/kube-news:${{ github.sha }}

    deploy:
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        needs: build
        uses: vinicius3516/devops-tools/.github/workflows/deploy-do.yml@main
        with:
            ambiente: ${{ github.event.inputs.ambiente || 'dev' }}
            image_tag: ${{ github.sha }}
            manifests: |
                k8s/deployment.yaml
                k8s/ingress.yaml
                k8s/secret.yaml
        secrets:
            kubeconfig: ${{ secrets.KUBECONFIG }}
                  
